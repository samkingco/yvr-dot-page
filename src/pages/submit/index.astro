---
import { drizzle } from "drizzle-orm/d1"
import * as v from "valibot"
import Paragraph from "../../components/Paragraph.astro"
import { schema, validation } from "../../db"
import Layout from "../../layouts/Layout.astro"

const { env } = Astro.locals.runtime
const db = drizzle(env.DB, { schema })

const initialValues = {
	username: Astro.url.searchParams.get("username") ?? "",
	name: Astro.url.searchParams.get("name") ?? "",
	does: Astro.url.searchParams.get("does") ?? "",
	website: Astro.url.searchParams.get("website") ?? "",
	bio: Astro.url.searchParams.get("bio") ?? "",
}

const errors = [
	["username", Astro.url.searchParams.get("error.username")],
	["name", Astro.url.searchParams.get("error.name")],
	["does", Astro.url.searchParams.get("error.does")],
	["website", Astro.url.searchParams.get("error.website")],
	["bio", Astro.url.searchParams.get("error.bio")],
].filter(([_, value]) => !!value)

if (Astro.request.method === "POST") {
	try {
		const data = await Astro.request.formData()
		const unsafeWebsite = data.get("website")?.toString()
		const safeWebsite =
			unsafeWebsite &&
			new URL(
				unsafeWebsite.startsWith("http")
					? unsafeWebsite
					: `https://${unsafeWebsite}`,
			)

		const person = {
			username: data.get("username")?.toString() ?? "",
			name: data.get("name")?.toString() ?? "",
			does: data.get("does")?.toString() ?? "",
			website: safeWebsite?.toString() ?? "",
			bio: data.get("bio")?.toString() ?? "",
		}

		const returnUrl = new URL(Astro.url.pathname, Astro.url.origin)
		returnUrl.searchParams.set("username", person.username)
		returnUrl.searchParams.set("name", person.name)
		returnUrl.searchParams.set("does", person.does)
		returnUrl.searchParams.set("website", person.website)
		returnUrl.searchParams.set("bio", person?.bio)

		const parsed = v.safeParse(validation.personSchema, person)

		if (!parsed.success) {
			for (const issue of parsed.issues) {
				if (issue.path) {
					returnUrl.searchParams.set(
						`error.${issue.path.map((p) => p.key).join(".")}`,
						issue.message,
					)
				}
			}
			return Astro.redirect(returnUrl.toString())
		}

		// Check the username is not already taken
		const existing = await db.query.people.findFirst({
			where: (p, { eq }) => eq(p.username, parsed.output.username),
		})

		if (existing) {
			returnUrl.searchParams.set("error.username", "username is already taken")
			return Astro.redirect(returnUrl.toString())
		}

		await db.insert(schema.people).values(parsed.output)
		return Astro.redirect("/submit/success")
	} catch (error) {
		if (error instanceof Error) {
			console.error(error.message)
		}
	}
}
---

<Layout title="Submit">
  <main class="max-w-lg flex flex-col gap-8">
    {errors.length > 0 && (
      <div class="font-bold text-sm">
        <Paragraph>there {errors.length === 1 ? "was an issue" : "were some issues"} with your submissionâ€¦</Paragraph>
        <ul>
          {errors.map(([key, error]) => (
            <li>
              <Paragraph>&nbsp;+ {error}</Paragraph>
            </li>
          ))}
        </ul>
      </div>
    )}

    <form method="POST" class="flex flex-col gap-8">
      <label class="flex flex-col cursor-pointer">
        <Paragraph class="text-sm">
          <span class="font-bold">
            {errors.some(([key]) => key === "username") && "+ "}username
          </span>
          <span class="sr-only">;</span>
          <span class="block">
            yvr.page/people/<span class="font-bold" data-username-placeholder></span>
          </span>
        </Paragraph>
        <input
          type="text"
          name="username"
          value={initialValues.username}
          class="text-sm leading-snug py-3 outline-none bg-background border-b-2 border-foreground/20 hover:border-foreground/30 focus-visible:border-foreground motion-safe:transition-colors motion-safe:duration-150 motion-safe:ease-out"
        />
      </label>
      
      <label class="flex flex-col cursor-pointer">
        <Paragraph class="text-sm">
          <span class="font-bold">
            {errors.some(([key]) => key === "name") && "+ "}name
          </span>
          (optional)<span class="sr-only">;</span>
          <span class="block">
            will fall back to your username if not set
          </span>
        </Paragraph>
        <input
          type="text"
          name="name"
          value={initialValues.name}
          class="text-sm leading-snug py-3 outline-none bg-background border-b-2 border-foreground/20 hover:border-foreground/30 focus-visible:border-foreground motion-safe:transition-colors motion-safe:duration-150 motion-safe:ease-out placeholder:text-foreground/30"
        />
      </label>

      <label class="flex flex-col cursor-pointer">
        <Paragraph class="text-sm">
          <span class="font-bold">
            {errors.some(([key]) => key === "does") && "+ "}what do you do?
          </span>
          <span class="sr-only">;</span>
          <span class="block">
            for example: painter, software engineer, photographer, etc.
          </span>
        </Paragraph>
        <input
          type="text"
          name="does"
          value={initialValues.does}
          class="text-sm leading-snug py-3 outline-none bg-background border-b-2 border-foreground/20 hover:border-foreground/30 focus-visible:border-foreground motion-safe:transition-colors motion-safe:duration-150 motion-safe:ease-out"
        />
      </label>

      <label class="flex flex-col cursor-pointer">
        <Paragraph class="text-sm">
          <span class="font-bold">
            {errors.some(([key]) => key === "website") && "+ "}website or social profile
          </span>
          <span class="sr-only">;</span>
          <span class="block">
            will be linked so people can contact you
          </span>
        </Paragraph>
        <input
          type="text"
          inputmode="url"
          name="website"
          value={initialValues.website}
          class="text-sm leading-snug py-3 outline-none bg-background border-b-2 border-foreground/20 hover:border-foreground/30 focus-visible:border-foreground motion-safe:transition-colors motion-safe:duration-150 motion-safe:ease-out"
        />
      </label>

      <label class="flex flex-col cursor-pointer">
        <Paragraph class="text-sm">
          <span class="font-bold">
            {errors.some(([key]) => key === "bio") && "+ "}short bio
          </span>
          <span class="sr-only">;</span>
          <span class="block">
            a prompt: what are you passionate about? what is your purpose? what are you looking for in life?
          </span>
        </Paragraph>
        <textarea
          name="bio"
          rows="4"
          class="text-sm leading-snug py-3 outline-none bg-background border-b-2 border-foreground/20 hover:border-foreground/30 focus-visible:border-foreground motion-safe:transition-colors motion-safe:duration-150 motion-safe:ease-out resize-none"
        >{initialValues.bio}</textarea>
      </label>

      <button class="px-4 py-3 w-fit outline-none font-bold text-sm border-2 border-foreground/20 hover:bg-foreground hover:text-background focus-visible:bg-foreground focus-visible:text-background motion-safe:transition-colors motion-safe:duration-100 motion-safe:ease-out">submit &rarr;</button>
    </form>
  </main>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const usernamePlaceholder = document.querySelector<HTMLSpanElement>('[data-username-placeholder]')
    const usernameInput = document.querySelector<HTMLInputElement>('input[name="username"]')
    const nameInput = document.querySelector<HTMLInputElement>('input[name="name"]')
    
    function onInputChange() {
      if (usernamePlaceholder && usernameInput) {
        const inputValue = usernameInput.value.trim()
        usernamePlaceholder.textContent = inputValue || ""
      }

      if (usernameInput && nameInput) {
        nameInput.placeholder = usernameInput.value.trim()
      }
    }

    usernameInput?.addEventListener('input', onInputChange)
  });
</script>